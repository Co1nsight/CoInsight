name: Spring Boot CI/CD Pipeline with Docker Compose

on:
  push:
    branches: [release]
  pull_request:
    branches: [release]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/spring-app

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 코드 체크아웃
      - uses: actions/checkout@v4
      
      # JDK 21 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
          
      # Gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      # 테스트 실행
      - name: Test with Gradle
        run: ./gradlew test
        
      # 빌드 (테스트 제외)
      - name: Build with Gradle
        run: ./gradlew clean build -x test
        
      # Docker 이미지 빌드 및 푸시
      - name: Docker build and push
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker build --platform linux/amd64 -t ${{ env.DOCKER_IMAGE }}:latest .
          docker push ${{ env.DOCKER_IMAGE }}:latest
      
      # GitHub Actions IP 가져오기
      - name: Get Github Actions IP
        id: ip
        uses: haythem/public-ip@v1.2
      
      # AWS 자격 증명 설정
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      # GitHub Actions IP를 AWS 보안 그룹에 추가
      - name: Add Github Actions IP to Security group
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port ${{ secrets.PORT }} --cidr ${{ steps.ip.outputs.ipv4 }}/32
        continue-on-error: true

      # 필요한 파일만 EC2에 복사
      - name: Copy docker-compose files to EC2
        run: |
          # SSH key를 임시 파일로 저장
          echo "${{ secrets.KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key

          # EC2에 디렉토리 생성
          ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no -p ${{ secrets.PORT }} ${{ secrets.USER_NAME }}@${{ secrets.HOST }} "mkdir -p /home/ubuntu/spring-server/nginx"

          # 파일 복사
          scp -i /tmp/ssh_key -o StrictHostKeyChecking=no -P ${{ secrets.PORT }} docker-compose.yml ${{ secrets.USER_NAME }}@${{ secrets.HOST }}:/home/ubuntu/spring-server/
          scp -i /tmp/ssh_key -o StrictHostKeyChecking=no -P ${{ secrets.PORT }} -r nginx/* ${{ secrets.USER_NAME }}@${{ secrets.HOST }}:/home/ubuntu/spring-server/nginx/

          # SSH key 삭제
          rm -f /tmp/ssh_key

      # SSH로 EC2 접속 및 배포
      - name: Deploy to EC2 with Docker Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER_NAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /home/ubuntu/spring-server

            # .env 파일이 없으면 생성
            if [ ! -f .env ]; then
              echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" > .env
            fi

            # Docker 로그인
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            # 기존 컨테이너 중지 및 제거
            sudo docker-compose down

            # 최신 이미지 pull
            sudo docker pull ${{ env.DOCKER_IMAGE }}:latest

            # docker-compose로 컨테이너 실행
            sudo docker-compose up -d

            # 사용하지 않는 이미지 정리
            sudo docker image prune -f

            # 컨테이너 상태 확인
            echo "Waiting for application to start..."
            sleep 15

            # 컨테이너 실행 확인
            if sudo docker-compose ps | grep -q "Up"; then
              echo "✅ Application started successfully"
              sudo docker-compose logs --tail=50
            else
              echo "❌ Application failed to start"
              sudo docker-compose logs
              exit 1
            fi
      
      # AWS 보안 그룹에서 GitHub Actions IP 제거
      - name: Remove Github Actions IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port ${{ secrets.PORT }} --cidr ${{ steps.ip.outputs.ipv4 }}/32
